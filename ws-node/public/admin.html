<!--
  CampusChat Admin Control Panel
  
  Purpose: Administrative interface for system management and moderation
  Type: HTML5 Single Page Application (Admin Only)
  
  Features:
  - User account approval/rejection (pending queue)
  - Role assignment (Student, Faculty, Admin, Super Admin)
  - User account management (disable/enable)
  - System statistics and monitoring
  - Message moderation and flagging
  - Storage usage and cleanup
  - Conversation monitoring (super-admin)
  - Dashboard with key metrics
  
  Access Control:
  - Admin role minimum required
  - Super Admin for advanced moderation features
  - Redirects non-admin users to login
  
  Architecture:
  - Session verification before loading
  - Tabbed interface for different admin functions
  - Real-time data refresh
  - Responsive design for desktop/tablet
  
  Stylesheets: chat.css (shared), admin.css (admin-specific)
  Scripts: app.js (authentication), admin-specific code
-->

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CampusChat â€” Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="chat.css" />
    <link rel="stylesheet" href="admin.css" />
  </head>
  <body>
    <!-- Loading screen shown while checking saved session -->
    <div
      id="adminLoadingScreen"
      style="
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background: var(--bg-base);
        flex-direction: column;
        gap: 16px;
      "
    >
      <div
        style="
          width: 36px;
          height: 36px;
          border: 3px solid var(--border-strong);
          border-top-color: var(--accent);
          border-radius: 50%;
          animation: spin 0.7s linear infinite;
        "
      ></div>
      <div
        style="
          font-size: 13px;
          color: var(--text-muted);
          font-family: var(--font-mono);
        "
      >
        Checking sessionâ€¦
      </div>
    </div>

    <!-- Admin Login -->
    <div id="adminLogin" class="hidden">
      <div class="login-card">
        <div class="login-logo">
          <div class="login-logo-icon">ğŸ›¡ï¸</div>
          <div>
            <div class="login-logo-text">Campus<span>Chat</span></div>
            <div class="login-subtitle">ADMIN PANEL</div>
          </div>
        </div>
        <div class="field-group">
          <label>Username</label>
          <input
            id="adminUsername"
            type="text"
            placeholder="Admin username"
            autocomplete="username"
          />
        </div>
        <div class="field-group">
          <label>Password</label>
          <input id="adminPassword" type="password" placeholder="Password" />
        </div>
        <button class="btn-primary" onclick="adminLogin()">
          Sign In as Admin
        </button>
        <p id="adminLoginError"></p>
        <p
          style="
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 14px;
          "
        >
          <a href="/" style="color: var(--accent)">â† Back to Chat</a>
        </p>
      </div>
    </div>

    <!-- Admin App -->
    <div id="adminApp" class="hidden">
      <div id="adminNav">
        <div class="admin-nav-logo">
          <span id="adminRoleIcon">ğŸ›¡ï¸</span>
          <span>CampusChat Admin</span>
          <span id="adminRoleBadge" class="admin-role-badge"></span>
        </div>
        <div class="admin-nav-tabs">
          <button
            class="admin-tab active"
            data-tab="pending"
            onclick="switchAdminTab(this, 'pending')"
          >
            Pending Approvals
            <span id="pendingCount" class="admin-badge hidden">0</span>
          </button>
          <button
            class="admin-tab"
            data-tab="active"
            onclick="switchAdminTab(this, 'active')"
          >
            Active Users
          </button>
          <button
            class="admin-tab"
            data-tab="disabled"
            onclick="switchAdminTab(this, 'disabled')"
          >
            Disabled
          </button>
          <!-- Storage tab: super_admin only â€” shown via JS after login -->
          <button
            class="admin-tab hidden"
            id="chatsTabBtn"
            data-tab="chats"
            onclick="switchAdminTab(this, 'chats')"
          >
            ğŸ’¬ Chat Monitor
            <span id="flaggedCount" class="admin-badge hidden">0</span>
          </button>
          <button
            class="admin-tab hidden"
            id="flaggedTabBtn"
            data-tab="flagged"
            onclick="switchAdminTab(this, 'flagged')"
          >
            ğŸš© Flagged
          </button>
          <button
            class="admin-tab hidden"
            id="storageTabBtn"
            data-tab="storage"
            onclick="switchAdminTab(this, 'storage')"
          >
            ğŸ’¾ Storage
          </button>
        </div>
        <div class="admin-nav-right">
          <span
            id="adminMyName"
            style="font-size: 13px; color: var(--text-secondary)"
          ></span>
          <button
            id="adminThemeBtn"
            class="icon-btn"
            title="Toggle theme"
            onclick="toggleTheme()"
          >
            <svg
              id="adminThemeIcon"
              width="15"
              height="15"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="12" cy="12" r="5" />
              <line x1="12" y1="1" x2="12" y2="3" />
              <line x1="12" y1="21" x2="12" y2="23" />
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
              <line x1="1" y1="12" x2="3" y2="12" />
              <line x1="21" y1="12" x2="23" y2="12" />
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
            </svg>
          </button>
          <button class="icon-btn" title="Logout" onclick="adminLogout()">
            <svg
              width="15"
              height="15"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
              <polyline points="16 17 21 12 16 7" />
              <line x1="21" y1="12" x2="9" y2="12" />
            </svg>
          </button>
        </div>
      </div>

      <div id="adminContent">
        <!-- Search + filter bar (hidden on storage tab) -->
        <div class="admin-toolbar" id="adminToolbar">
          <div class="admin-search-wrap">
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="11" cy="11" r="8" />
              <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
            <input
              id="adminSearch"
              type="text"
              placeholder="Search usersâ€¦"
              oninput="filterUsers(this.value)"
            />
          </div>
          <button
            class="btn-modal-primary"
            onclick="loadUsers()"
            style="padding: 8px 16px; font-size: 13px"
          >
            <svg
              width="13"
              height="13"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.2"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="display: inline; margin-right: 4px; vertical-align: middle"
            >
              <path d="M23 4v6h-6" />
              <path d="M1 20v-6h6" />
              <path
                d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
              />
            </svg>
            Refresh
          </button>
        </div>

        <!-- User table (shown on user tabs) -->
        <div id="userTableWrap">
          <table id="userTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Username</th>
                <th>Role</th>
                <th>Department</th>
                <th>Registered</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="userTableBody">
              <tr>
                <td colspan="6" class="table-empty">Loadingâ€¦</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Chat Monitor panel (super_admin only) -->
        <div id="chatsPanel" class="hidden">
          <!-- Global message search -->
          <div class="monitor-search-bar">
            <div class="admin-search-wrap" style="max-width: 480px">
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
              </svg>
              <input
                id="msgSearchInput"
                type="text"
                placeholder="Search messages across all chatsâ€¦"
                oninput="debounceMessageSearch(this.value)"
              />
            </div>
            <div class="conv-type-filter">
              <button
                class="filter-btn active"
                onclick="setConvFilter(this, 'all')"
              >
                All
              </button>
              <button
                class="filter-btn"
                onclick="setConvFilter(this, 'direct')"
              >
                Direct
              </button>
              <button class="filter-btn" onclick="setConvFilter(this, 'group')">
                Groups
              </button>
            </div>
            <button
              class="btn-modal-primary"
              onclick="refreshChats()"
              style="padding: 8px 16px; font-size: 13px"
            >
              Refresh
            </button>
          </div>

          <!-- Search results (hidden by default) -->
          <div id="msgSearchResults" class="hidden">
            <div class="section-label">
              Search Results
              <span id="searchResultCount" class="muted-count"></span>
            </div>
            <div id="msgSearchList"></div>
          </div>

          <!-- Conversation list + message viewer -->
          <div id="monitorLayout" class="monitor-layout">
            <!-- Left: conversation list -->
            <div id="monitorConvList" class="monitor-conv-list">
              <div class="table-empty" style="padding: 32px 16px">
                Click Refresh to load conversations.
              </div>
            </div>

            <!-- Right: message viewer -->
            <div id="monitorMsgPane" class="monitor-msg-pane">
              <div class="monitor-empty">
                <div style="font-size: 32px; margin-bottom: 12px">ğŸ’¬</div>
                <div style="font-size: 14px; color: var(--text-muted)">
                  Select a conversation to view messages
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Flagged Messages panel (super_admin only) -->
        <div id="flaggedPanel" class="hidden">
          <div class="storage-toolbar">
            <span style="font-size: 13px; color: var(--text-secondary)"
              >All flagged messages â€” click ğŸš© to unflag</span
            >
            <button
              class="btn-modal-primary"
              onclick="loadFlaggedMessages()"
              style="padding: 8px 16px; font-size: 13px"
            >
              Refresh
            </button>
          </div>
          <div id="flaggedList">
            <div class="table-empty" style="padding: 48px">
              Click Refresh to load flagged messages.
            </div>
          </div>
        </div>

        <!-- Storage panel (super_admin only) -->
        <div id="storagePanel" class="hidden">
          <div class="storage-stats">
            <div class="stat-card">
              <div class="stat-label">Total Files</div>
              <div class="stat-value" id="statTotalFiles">â€”</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">DB Tracked Size</div>
              <div class="stat-value" id="statDbSize">â€”</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Actual Disk Used</div>
              <div class="stat-value" id="statDiskUsed">â€”</div>
            </div>
            <div class="stat-card warn">
              <div class="stat-label">Stale Files (6+ months)</div>
              <div class="stat-value" id="statStaleCount">â€”</div>
            </div>
            <div class="stat-card warn">
              <div class="stat-label">Reclaimable Space</div>
              <div class="stat-value" id="statStaleSize">â€”</div>
            </div>
          </div>

          <div class="storage-toolbar">
            <span style="font-size: 13px; color: var(--text-secondary)"
              >Files not accessed in the last 6 months</span
            >
            <div style="display: flex; gap: 8px">
              <button
                class="btn-modal-primary"
                onclick="loadStorage()"
                style="padding: 8px 16px; font-size: 13px"
              >
                Refresh
              </button>
              <button
                class="action-btn reject"
                id="deleteAllBtn"
                onclick="cleanupAll()"
                style="padding: 8px 16px; font-size: 13px"
              >
                Delete All Stale
              </button>
            </div>
          </div>

          <div id="staleTableWrap">
            <table id="staleTable">
              <thead>
                <tr>
                  <th>
                    <input
                      type="checkbox"
                      id="selectAllStale"
                      onchange="toggleSelectAll(this)"
                    />
                  </th>
                  <th>File Name</th>
                  <th>Type</th>
                  <th>Size</th>
                  <th>Uploaded By</th>
                  <th>Last Accessed</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="staleTableBody">
                <tr>
                  <td colspan="7" class="table-empty">
                    Click Refresh to load storage data.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="storage-selection-bar hidden" id="selectionBar">
            <span id="selectionCount">0 files selected</span>
            <button class="action-btn reject" onclick="cleanupSelected()">
              Delete Selected
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="toast"></div>

    <script>
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // THEME
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      function applyTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem("cc_theme", theme);
        const icon = document.getElementById("adminThemeIcon");
        if (!icon) return;
        if (theme === "light") {
          icon.innerHTML = `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>`;
        } else {
          icon.innerHTML = `<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>`;
        }
      }
      function toggleTheme() {
        const current =
          document.documentElement.getAttribute("data-theme") || "dark";
        applyTheme(current === "dark" ? "light" : "dark");
      }
      // Load saved theme on startup â€” shared with chat.css via localStorage key
      (function () {
        applyTheme(localStorage.getItem("cc_theme") || "dark");
      })();

      const API_BASE = "http://localhost/campus-chat/api/index.php";
      let adminToken = null;
      let myRole = null; // 'admin' or 'super_admin'
      let currentTab = "pending";
      let allUsers = [];
      let staleFiles = [];
      let selectedStale = new Set();

      // â”€â”€ Shared post-login UI setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function initAdminApp(user) {
        document.getElementById("adminLoadingScreen").style.display = "none";
        document.getElementById("adminLogin").classList.add("hidden");
        document.getElementById("adminApp").classList.remove("hidden");
        document.getElementById("adminMyName").textContent =
          user.full_name || user.username;

        const badge = document.getElementById("adminRoleBadge");
        if (myRole === "super_admin") {
          badge.textContent = "Super Admin";
          badge.className = "admin-role-badge super";
          document.getElementById("adminRoleIcon").textContent = "ğŸ‘‘";
          document.getElementById("storageTabBtn").classList.remove("hidden");
          document.getElementById("chatsTabBtn").classList.remove("hidden");
          document.getElementById("flaggedTabBtn").classList.remove("hidden");
        } else {
          badge.textContent = "Admin";
          badge.className = "admin-role-badge";
        }

        await loadUsers();
      }

      // â”€â”€ Session restore on page load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      (async function restoreAdminSession() {
        const savedToken = localStorage.getItem("cc_admin_token");
        const savedUserStr = localStorage.getItem("cc_admin_user");

        if (!savedToken || !savedUserStr) {
          // No saved session â€” show login
          document.getElementById("adminLoadingScreen").style.display = "none";
          document.getElementById("adminLogin").classList.remove("hidden");
          return;
        }

        let savedUser;
        try {
          savedUser = JSON.parse(savedUserStr);
        } catch {
          localStorage.removeItem("cc_admin_token");
          localStorage.removeItem("cc_admin_user");
          document.getElementById("adminLoadingScreen").style.display = "none";
          document.getElementById("adminLogin").classList.remove("hidden");
          return;
        }

        const role = savedUser.role;
        if (role !== "admin" && role !== "super_admin") {
          localStorage.removeItem("cc_admin_token");
          localStorage.removeItem("cc_admin_user");
          document.getElementById("adminLoadingScreen").style.display = "none";
          document.getElementById("adminLogin").classList.remove("hidden");
          return;
        }

        // Restore session immediately from localStorage â€” no network call needed
        // If token is truly expired, the first API call (loadUsers) will fail with 401
        adminToken = savedToken;
        myRole = role;

        document.getElementById("adminLoadingScreen").style.display = "none";
        await initAdminApp(savedUser);
      })();

      // â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function adminLogin() {
        const username = document.getElementById("adminUsername").value.trim();
        const password = document.getElementById("adminPassword").value;
        const errEl = document.getElementById("adminLoginError");
        errEl.textContent = "";

        try {
          const res = await fetch(`${API_BASE}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });
          const data = await res.json();
          if (!res.ok) {
            errEl.textContent = data.error || "Login failed.";
            return;
          }

          const role = data.user.role;
          if (role !== "admin" && role !== "super_admin") {
            errEl.textContent = "Access denied â€” admin accounts only.";
            return;
          }

          adminToken = data.access_token;
          myRole = role;

          // Save admin session to localStorage
          localStorage.setItem("cc_admin_token", adminToken);
          localStorage.setItem("cc_admin_user", JSON.stringify(data.user));

          await initAdminApp(data.user);
        } catch (err) {
          errEl.textContent = "Connection error.";
          console.error(err);
        }
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !adminToken) adminLogin();
      });

      function adminLogout() {
        adminToken = null;
        myRole = null;
        localStorage.removeItem("cc_admin_token");
        localStorage.removeItem("cc_admin_user");
        location.reload();
      }

      // â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function switchAdminTab(btn, tab) {
        document
          .querySelectorAll(".admin-tab")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        currentTab = tab;
        document.getElementById("adminSearch").value = "";

        const isStorage = tab === "storage";
        const isChats = tab === "chats";
        const isFlagged = tab === "flagged";
        const isUserTab = !isStorage && !isChats && !isFlagged;

        document
          .getElementById("userTableWrap")
          .classList.toggle("hidden", !isUserTab);
        document
          .getElementById("adminToolbar")
          .classList.toggle("hidden", !isUserTab);
        document
          .getElementById("storagePanel")
          .classList.toggle("hidden", !isStorage);
        document
          .getElementById("chatsPanel")
          .classList.toggle("hidden", !isChats);
        document
          .getElementById("flaggedPanel")
          .classList.toggle("hidden", !isFlagged);

        if (isStorage) loadStorage();
        else if (isChats) {
          loadConversations();
          loadFlaggedMessages();
        } else if (isFlagged) loadFlaggedMessages();
        else renderUsers();
      }

      // â”€â”€ Load users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function loadUsers() {
        try {
          const res = await fetch(`${API_BASE}/admin/users`, {
            headers: { Authorization: "Bearer " + adminToken },
          });
          const data = await res.json();
          if (!res.ok) {
            if (res.status === 401) {
              // Token expired â€” clear session and reload to show login
              localStorage.removeItem("cc_admin_token");
              localStorage.removeItem("cc_admin_user");
              location.reload();
              return;
            }
            showToast(data.error || "Failed to load users.");
            return;
          }
          allUsers = data.users || [];
          renderUsers();
          updatePendingBadge();
        } catch (err) {
          showToast("Connection error.");
          console.error(err);
        }
      }

      function updatePendingBadge() {
        const count = allUsers.filter((u) => u.status === "pending").length;
        const badge = document.getElementById("pendingCount");
        badge.textContent = count;
        badge.classList.toggle("hidden", count === 0);
      }

      function filterUsers(q) {
        q = q.toLowerCase();
        document
          .querySelectorAll("#userTableBody tr[data-uid]")
          .forEach((row) => {
            row.style.display = row.textContent.toLowerCase().includes(q)
              ? ""
              : "none";
          });
      }

      function renderUsers() {
        const tbody = document.getElementById("userTableBody");
        const filtered = allUsers.filter((u) => u.status === currentTab);

        if (filtered.length === 0) {
          const msgs = {
            pending: "No pending registrations ğŸ‰",
            active: "No active users yet",
            disabled: "No disabled accounts",
          };
          tbody.innerHTML = `<tr><td colspan="6" class="table-empty">${msgs[currentTab] || "No users"}</td></tr>`;
          return;
        }

        tbody.innerHTML = filtered
          .map(
            (u) => `
          <tr data-uid="${u.id}">
            <td>
              <div class="user-cell">
                <div class="user-avatar-sm">${initials(u.full_name || u.username)}</div>
                <span>${escapeHtml(u.full_name || "â€”")}</span>
              </div>
            </td>
            <td><span class="mono">@${escapeHtml(u.username)}</span></td>
            <td>${roleCell(u)}</td>
            <td>${escapeHtml(u.department || "â€”")}</td>
            <td><span class="mono">${formatDate(u.created_at)}</span></td>
            <td>${actionButtons(u)}</td>
          </tr>
        `,
          )
          .join("");
      }

      // Role cell: super_admin sees dropdown, admin sees read-only badge
      function roleCell(u) {
        if (myRole === "super_admin") {
          return `<select class="role-select" onchange="changeRole(${u.id}, this.value)">
            <option value="student"     ${u.role === "student" ? "selected" : ""}>Student</option>
            <option value="faculty"     ${u.role === "faculty" ? "selected" : ""}>Faculty</option>
            <option value="admin"       ${u.role === "admin" ? "selected" : ""}>Admin</option>
            <option value="super_admin" ${u.role === "super_admin" ? "selected" : ""}>Super Admin</option>
          </select>`;
        }
        // Normal admin: read-only role badge
        const labels = {
          student: "Student",
          faculty: "Faculty",
          admin: "Admin",
          super_admin: "Super Admin",
        };
        const cls =
          u.role === "super_admin"
            ? "role-badge-display super"
            : u.role === "admin"
              ? "role-badge-display admin"
              : "role-badge-display";
        return `<span class="${cls}">${labels[u.role] || u.role}</span>`;
      }

      function actionButtons(u) {
        // Prevent normal admin from acting on super_admin accounts
        const isProtected =
          u.role === "super_admin" && myRole !== "super_admin";

        if (u.status === "pending") {
          return `<div class="action-btns">
            <button class="action-btn approve" onclick="approveUser(${u.id})" ${isProtected ? "disabled" : ""}>âœ“ Approve</button>
            <button class="action-btn reject"  onclick="disableUser(${u.id})" ${isProtected ? "disabled" : ""}>âœ• Reject</button>
          </div>`;
        }
        if (u.status === "active") {
          return `<div class="action-btns">
            <button class="action-btn disable" onclick="disableUser(${u.id})" ${isProtected ? "disabled" : ""}>Disable</button>
          </div>`;
        }
        if (u.status === "disabled") {
          return `<div class="action-btns">
            <button class="action-btn approve" onclick="approveUser(${u.id})" ${isProtected ? "disabled" : ""}>Re-enable</button>
          </div>`;
        }
        return "";
      }

      // â”€â”€ User actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function approveUser(userId) {
        // For normal admin approvals, role is locked to student/faculty only
        // The dropdown in the row shows the current value
        const roleEl = document.querySelector(
          `tr[data-uid="${userId}"] .role-select`,
        );
        const role = roleEl ? roleEl.value : "student";

        try {
          const res = await fetch(`${API_BASE}/admin/users/approve`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + adminToken,
            },
            body: JSON.stringify({ user_id: userId, role }),
          });
          const data = await res.json();
          if (!res.ok) {
            showToast(data.error || "Failed.");
            return;
          }
          showToast("User approved!");
          await loadUsers();
        } catch {
          showToast("Connection error.");
        }
      }

      async function disableUser(userId) {
        if (!confirm("Disable this account?")) return;
        try {
          const res = await fetch(`${API_BASE}/admin/users/disable`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + adminToken,
            },
            body: JSON.stringify({ user_id: userId }),
          });
          const data = await res.json();
          if (!res.ok) {
            showToast(data.error || "Failed.");
            return;
          }
          showToast("Account disabled.");
          await loadUsers();
        } catch {
          showToast("Connection error.");
        }
      }

      async function changeRole(userId, newRole) {
        try {
          const res = await fetch(`${API_BASE}/admin/users/role`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + adminToken,
            },
            body: JSON.stringify({ user_id: userId, role: newRole }),
          });
          const data = await res.json();
          if (!res.ok) {
            showToast(data.error || "Failed.");
            await loadUsers();
            return;
          }
          showToast("Role updated.");
          const u = allUsers.find((u) => u.id === userId);
          if (u) u.role = newRole;
        } catch {
          showToast("Connection error.");
        }
      }

      // â”€â”€ Storage (super_admin only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function loadStorage() {
        document.getElementById("staleTableBody").innerHTML =
          `<tr><td colspan="7" class="table-empty">Loadingâ€¦</td></tr>`;
        try {
          const res = await fetch(`${API_BASE}/admin/storage`, {
            headers: { Authorization: "Bearer " + adminToken },
          });
          const data = await res.json();
          if (!res.ok) {
            showToast(data.error || "Failed.");
            return;
          }

          document.getElementById("statTotalFiles").textContent =
            data.total_files.toLocaleString();
          document.getElementById("statDbSize").textContent = fmtBytes(
            data.total_bytes,
          );
          document.getElementById("statDiskUsed").textContent = fmtBytes(
            data.disk_bytes,
          );
          document.getElementById("statStaleCount").textContent =
            data.stale_count.toLocaleString();
          document.getElementById("statStaleSize").textContent = fmtBytes(
            data.stale_bytes,
          );

          staleFiles = data.stale_files || [];
          selectedStale.clear();
          renderStaleTable();
          document.getElementById("deleteAllBtn").disabled =
            staleFiles.length === 0;
        } catch (err) {
          showToast("Connection error.");
          console.error(err);
        }
      }

      function renderStaleTable() {
        const tbody = document.getElementById("staleTableBody");
        if (!staleFiles.length) {
          tbody.innerHTML = `<tr><td colspan="7" class="table-empty">ğŸ‰ No stale files found!</td></tr>`;
          updateSelectionBar();
          return;
        }
        tbody.innerHTML = staleFiles
          .map(
            (f) => `
          <tr data-fid="${f.id}">
            <td><input type="checkbox" class="stale-cb" value="${f.id}" ${selectedStale.has(f.id) ? "checked" : ""} onchange="toggleStaleSelect(${f.id},this.checked)" /></td>
            <td><span class="mono" title="${escapeHtml(f.original_name)}">${escapeHtml(truncate(f.original_name, 36))}</span></td>
            <td><span class="mono">${escapeHtml(f.mime_type.split("/")[1] || f.mime_type)}</span></td>
            <td><span class="mono">${fmtBytes(f.file_size)}</span></td>
            <td>${escapeHtml(f.uploader_name || f.uploader_username)}</td>
            <td><span class="mono">${formatDate(f.last_accessed)}</span></td>
            <td><button class="action-btn reject" onclick="cleanupOne(${f.id})">Delete</button></td>
          </tr>`,
          )
          .join("");
        updateSelectionBar();
      }

      function toggleStaleSelect(id, checked) {
        if (checked) selectedStale.add(id);
        else selectedStale.delete(id);
        updateSelectionBar();
      }
      function toggleSelectAll(cb) {
        document.querySelectorAll(".stale-cb").forEach((el) => {
          el.checked = cb.checked;
          const id = parseInt(el.value);
          if (cb.checked) selectedStale.add(id);
          else selectedStale.delete(id);
        });
        updateSelectionBar();
      }
      function updateSelectionBar() {
        document.getElementById("selectionCount").textContent =
          selectedStale.size +
          " file" +
          (selectedStale.size !== 1 ? "s" : "") +
          " selected";
        document
          .getElementById("selectionBar")
          .classList.toggle("hidden", selectedStale.size === 0);
      }

      async function cleanupAll() {
        if (!staleFiles.length) {
          showToast("No stale files to delete.");
          return;
        }
        if (
          !confirm(
            `Delete all ${staleFiles.length} stale file(s)? This cannot be undone.`,
          )
        )
          return;
        await runCleanup([]);
      }
      async function cleanupSelected() {
        if (!selectedStale.size) return;
        if (!confirm(`Delete ${selectedStale.size} selected file(s)?`)) return;
        await runCleanup(Array.from(selectedStale));
      }
      async function cleanupOne(id) {
        if (!confirm("Delete this file? Cannot be undone.")) return;
        await runCleanup([id]);
      }

      async function runCleanup(ids) {
        try {
          const res = await fetch(`${API_BASE}/admin/cleanup`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + adminToken,
            },
            body: JSON.stringify({ ids }),
          });
          const data = await res.json();
          if (!res.ok) {
            showToast(data.error || "Failed.");
            return;
          }
          showToast(
            `Deleted ${data.deleted} file(s), freed ${fmtBytes(data.freed_bytes)}.`,
          );
          await loadStorage();
        } catch {
          showToast("Connection error.");
        }
      }

      // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function initials(name) {
        if (!name) return "?";
        const p = name.trim().split(" ");
        return p.length >= 2
          ? (p[0][0] + p[p.length - 1][0]).toUpperCase()
          : name.slice(0, 2).toUpperCase();
      }
      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }
      function formatDate(dt) {
        if (!dt) return "â€”";
        return new Date(dt.replace(" ", "T")).toLocaleDateString([], {
          month: "short",
          day: "numeric",
          year: "numeric",
        });
      }
      function fmtBytes(bytes) {
        if (!bytes) return "0 B";
        if (bytes < 1024) return bytes + " B";
        if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
        if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + " MB";
        return (bytes / 1073741824).toFixed(2) + " GB";
      }
      function truncate(str, n) {
        return str.length > n ? str.slice(0, n) + "â€¦" : str;
      }

      function showToast(msg) {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.classList.add("show");
        clearTimeout(t._t);
        t._t = setTimeout(() => t.classList.remove("show"), 3000);
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // CHAT MONITORING (super_admin only)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      let allConversations = [];
      let convTypeFilter = "all";
      let currentMonitorCid = null;
      let msgSearchDebounce = null;

      // â”€â”€ Conversations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function loadConversations() {
        const listEl = document.getElementById("monitorConvList");
        listEl.innerHTML = `<div class="table-empty" style="padding:32px;">Loadingâ€¦</div>`;
        try {
          const params = new URLSearchParams();
          if (convTypeFilter !== "all") params.set("type", convTypeFilter);
          const res = await fetch(`${API_BASE}/admin/conversations?${params}`, {
            headers: { Authorization: "Bearer " + adminToken },
          });
          const data = await res.json();
          if (!res.ok) {
            showToast(data.error || "Failed.");
            return;
          }
          allConversations = data.conversations || [];
          renderConversationList();
        } catch (err) {
          showToast("Connection error.");
          console.error(err);
        }
      }

      function setConvFilter(btn, type) {
        document
          .querySelectorAll(".filter-btn")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        convTypeFilter = type;
        loadConversations();
      }

      function renderConversationList() {
        const listEl = document.getElementById("monitorConvList");
        if (!allConversations.length) {
          listEl.innerHTML = `<div class="table-empty" style="padding:32px;">No conversations found.</div>`;
          return;
        }
        listEl.innerHTML = allConversations
          .map((c) => {
            const isGroup = c.type === "group";
            const title = isGroup
              ? c.name || "Group #" + c.id
              : c.members.map((m) => m.full_name || m.username).join(" & ");
            const flagBadge =
              c.flag_count > 0
                ? `<span class="conv-flag-badge">ğŸš© ${c.flag_count}</span>`
                : "";
            const typeBadge = isGroup
              ? `<span class="conv-type-badge group">Group</span>`
              : `<span class="conv-type-badge">Direct</span>`;
            const active = c.id === currentMonitorCid ? "active" : "";
            return `<div class="monitor-conv-item ${active}" onclick="openMonitorConv(${c.id})" data-cid="${c.id}">
            <div class="monitor-conv-avatar">${isGroup ? "ğŸ‘¥" : "ğŸ‘¤"}</div>
            <div class="monitor-conv-info">
              <div class="monitor-conv-title">${escapeHtml(truncate(title, 40))} ${typeBadge} ${flagBadge}</div>
              <div class="monitor-conv-meta">${c.member_count} members Â· ${c.last_message_at ? formatDate(c.last_message_at) : "No messages"}</div>
            </div>
          </div>`;
          })
          .join("");
      }

      // â”€â”€ Messages viewer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function openMonitorConv(cid) {
        currentMonitorCid = cid;
        // Highlight active conv
        document
          .querySelectorAll(".monitor-conv-item")
          .forEach((el) =>
            el.classList.toggle("active", Number(el.dataset.cid) === cid),
          );

        const pane = document.getElementById("monitorMsgPane");
        const conv = allConversations.find((c) => c.id === cid);
        const isGroup = conv?.type === "group";
        const title = isGroup
          ? conv?.name || "Group"
          : conv?.members?.map((m) => m.full_name || m.username).join(" & ") ||
            "Conversation";

        pane.innerHTML = `
          <div class="monitor-msg-header">
            <div>
              <div class="monitor-msg-title">${escapeHtml(title)}</div>
              <div class="monitor-msg-meta">
                ${conv?.members?.map((m) => `<span class="member-pill">${escapeHtml(m.full_name || m.username)}</span>`).join("") || ""}
              </div>
            </div>
          </div>
          <div class="monitor-msg-list" id="monitorMsgList"><div class="table-empty" style="padding:32px;">Loading messagesâ€¦</div></div>`;

        try {
          const res = await fetch(
            `${API_BASE}/admin/conversations/messages?conversation_id=${cid}&limit=80`,
            { headers: { Authorization: "Bearer " + adminToken } },
          );
          const data = await res.json();
          if (!res.ok) {
            showToast(data.error || "Failed.");
            return;
          }
          renderMonitorMessages(data.messages || [], cid);
        } catch (err) {
          showToast("Connection error.");
          console.error(err);
        }
      }

      function renderMonitorMessages(messages, cid) {
        const listEl = document.getElementById("monitorMsgList");
        if (!messages.length) {
          listEl.innerHTML = `<div class="table-empty" style="padding:32px;">No messages yet.</div>`;
          return;
        }
        listEl.innerHTML = messages.map((m) => buildMonitorMsgHtml(m)).join("");
        listEl.scrollTop = listEl.scrollHeight;
      }

      // Convert regular uploads URL to admin uploads URL
      function toAdminFileUrl(url) {
        if (!url) return url;
        // Rewrite /uploads/filename to /admin/uploads/filename
        return url.replace(/\/uploads\//, "/admin/uploads/");
      }

      // Fetch a file as blob using admin token (for images in monitor view)
      const adminBlobCache = new Map();
      async function loadAdminImage(imgEl, url) {
        const absUrl = "http://localhost" + url;
        if (adminBlobCache.has(absUrl)) {
          imgEl.src = adminBlobCache.get(absUrl);
          return;
        }
        try {
          const res = await fetch(absUrl, {
            headers: { Authorization: "Bearer " + adminToken },
          });
          if (!res.ok) throw new Error("HTTP " + res.status);
          const blob = await res.blob();
          const blobUrl = URL.createObjectURL(blob);
          adminBlobCache.set(absUrl, blobUrl);
          imgEl.src = blobUrl;
        } catch (err) {
          imgEl.parentElement.innerHTML = `<div class="attach-err">Could not load image</div>`;
        }
      }

      async function downloadAdminFile(url, filename) {
        try {
          const absUrl = "http://localhost" + url;
          const res = await fetch(absUrl, {
            headers: { Authorization: "Bearer " + adminToken },
          });
          if (!res.ok) {
            showToast("Download failed.");
            return;
          }
          const blob = await res.blob();
          const blobUrl = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = blobUrl;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          setTimeout(() => URL.revokeObjectURL(blobUrl), 10000);
        } catch {
          showToast("Download error.");
        }
      }

      function buildAttachmentHtml(att) {
        if (!att) return "";
        const adminUrl = toAdminFileUrl(att.url);
        const isImage = [
          "image/jpeg",
          "image/png",
          "image/gif",
          "image/webp",
        ].includes(att.mime_type);
        if (isImage) {
          const uid = "adminimg_" + Math.random().toString(36).slice(2);
          // Load image after render using setTimeout
          setTimeout(() => {
            const el = document.getElementById(uid);
            if (el) loadAdminImage(el, adminUrl);
          }, 50);
          return `<div class="monitor-attach-image-wrap">
            <img id="${uid}" src="" alt="${escapeHtml(att.original_name)}"
                 class="monitor-attach-image" />
          </div>`;
        }
        // Document
        const icons = {
          "application/pdf": "ğŸ“„",
          "application/msword": "ğŸ“",
          "application/vnd.openxmlformats-officedocument.wordprocessingml.document":
            "ğŸ“",
          "application/vnd.ms-excel": "ğŸ“Š",
          "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":
            "ğŸ“Š",
          "application/vnd.ms-powerpoint": "ğŸ“‘",
          "application/vnd.openxmlformats-officedocument.presentationml.presentation":
            "ğŸ“‘",
        };
        const icon = icons[att.mime_type] || "ğŸ“";
        const size =
          att.file_size < 1048576
            ? (att.file_size / 1024).toFixed(1) + " KB"
            : (att.file_size / 1048576).toFixed(1) + " MB";
        return `<div class="monitor-attach-doc" onclick="downloadAdminFile('${escapeHtml(adminUrl)}','${escapeHtml(att.original_name)}')">
          <span>${icon}</span>
          <div>
            <div class="attach-doc-name">${escapeHtml(att.original_name)}</div>
            <div class="attach-doc-size">${size}</div>
          </div>
          <span>â¬‡</span>
        </div>`;
      }

      function buildMonitorMsgHtml(m, highlight = "") {
        const flagged = m.is_flagged || m.flag_count > 0;
        const bodyText = m.body || "";
        const displayBody = highlight
          ? escapeHtml(bodyText).replace(
              new RegExp(`(${escapeRegex(highlight)})`, "gi"),
              `<mark>$1</mark>`,
            )
          : escapeHtml(bodyText);
        const attachHtml = buildAttachmentHtml(m.attachment);
        return `<div class="monitor-msg-row ${flagged ? "flagged" : ""}" data-mid="${m.id}">
          <div class="monitor-msg-sender">
            <span class="monitor-sender-name">${escapeHtml(m.full_name || m.username)}</span>
            <span class="monitor-sender-handle">@${escapeHtml(m.username)}</span>
            <span class="monitor-msg-time">${formatDateTime(m.created_at)}</span>
            ${flagged ? `<span class="flag-indicator" title="${escapeHtml(m.flag_reason || "")}">ğŸš© Flagged</span>` : ""}
          </div>
          ${attachHtml}
          ${displayBody ? `<div class="monitor-msg-body">${displayBody}</div>` : ""}
          <div class="monitor-msg-actions">
            ${
              flagged
                ? `<button class="monitor-btn unflag" onclick="unflagMessage(${m.id}, this)">Remove Flag</button>`
                : `<button class="monitor-btn flag" onclick="showFlagDialog(${m.id}, this)">ğŸš© Flag</button>`
            }
          </div>
        </div>`;
      }

      // â”€â”€ Flag / Unflag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function showFlagDialog(messageId, btn) {
        const reason =
          prompt(
            "Optional: Enter reason for flagging this message (or leave blank):",
          ) ?? null;
        if (reason === null) return; // cancelled
        try {
          const res = await fetch(`${API_BASE}/admin/messages/flag`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + adminToken,
            },
            body: JSON.stringify({ message_id: messageId, reason }),
          });
          const data = await res.json();
          if (!res.ok) {
            showToast(data.error || "Failed.");
            return;
          }
          showToast("Message flagged.");
          // Update row in DOM
          const row = document.querySelector(
            `.monitor-msg-row[data-mid="${messageId}"]`,
          );
          if (row) {
            row.classList.add("flagged");
            row.querySelector(".monitor-msg-actions").innerHTML =
              `<button class="monitor-btn unflag" onclick="unflagMessage(${messageId}, this)">Remove Flag</button>`;
          }
          updateFlaggedBadge(1);
          loadFlaggedMessages();
        } catch {
          showToast("Connection error.");
        }
      }

      async function unflagMessage(messageId, btn) {
        if (!confirm("Remove flag from this message?")) return;
        try {
          const res = await fetch(`${API_BASE}/admin/messages/flag`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + adminToken,
            },
            body: JSON.stringify({ message_id: messageId }),
          });
          const data = await res.json();
          if (!res.ok) {
            showToast(data.error || "Failed.");
            return;
          }
          showToast("Flag removed.");
          const row = document.querySelector(
            `.monitor-msg-row[data-mid="${messageId}"]`,
          );
          if (row) {
            row.classList.remove("flagged");
            row.querySelector(".monitor-msg-actions").innerHTML =
              `<button class="monitor-btn flag" onclick="showFlagDialog(${messageId}, this)">ğŸš© Flag</button>`;
            row.querySelector(".flag-indicator")?.remove();
          }
          updateFlaggedBadge(-1);
          loadFlaggedMessages();
        } catch {
          showToast("Connection error.");
        }
      }

      function updateFlaggedBadge(delta) {
        const badge = document.getElementById("flaggedCount");
        let count = parseInt(badge.textContent || "0") + delta;
        if (count < 0) count = 0;
        badge.textContent = count;
        badge.classList.toggle("hidden", count === 0);
      }

      // â”€â”€ Flagged messages panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function loadFlaggedMessages() {
        try {
          const res = await fetch(`${API_BASE}/admin/messages/flagged`, {
            headers: { Authorization: "Bearer " + adminToken },
          });
          const data = await res.json();
          if (!res.ok) return;
          const flagged = data.flagged || [];

          // Update badge on Flagged tab
          const badge = document.getElementById("flaggedCount");
          badge.textContent = flagged.length;
          badge.classList.toggle("hidden", flagged.length === 0);

          const listEl = document.getElementById("flaggedList");
          if (!flagged.length) {
            listEl.innerHTML = `<div class="table-empty" style="padding:48px;">ğŸ‰ No flagged messages.</div>`;
            return;
          }
          listEl.innerHTML = flagged
            .map(
              (m) => `
            <div class="flagged-msg-card" data-mid="${m.id}">
              <div class="flagged-msg-header">
                <div>
                  <span class="monitor-sender-name">${escapeHtml(m.full_name || m.username)}</span>
                  <span class="monitor-sender-handle">@${escapeHtml(m.username)}</span>
                  <span class="conv-type-badge ${m.conv_type === "group" ? "group" : ""}" style="margin-left:6px;">${m.conv_type === "group" ? escapeHtml(m.conv_name || "Group") : "Direct"}</span>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                  <span class="monitor-msg-time">${formatDateTime(m.created_at)}</span>
                  <button class="monitor-btn unflag" onclick="unflagMessage(${m.id}, this)">Remove Flag</button>
                  <button class="monitor-btn view" onclick="viewConvFromFlag(${m.conversation_id})">View Chat</button>
                </div>
              </div>
              <div class="flagged-msg-body">${escapeHtml(m.body || "[attachment]")}</div>
              ${m.flag_reason ? `<div class="flag-reason">Reason: ${escapeHtml(m.flag_reason)}</div>` : ""}
              <div class="flag-meta">Flagged by ${escapeHtml(m.flagged_by_name || m.flagged_by_username)} Â· ${formatDateTime(m.flagged_at)}</div>
            </div>`,
            )
            .join("");
        } catch (err) {
          console.error(err);
        }
      }

      async function viewConvFromFlag(cid) {
        // 1. Clear search so we don't stay in search-results mode
        const searchInput = document.getElementById("msgSearchInput");
        if (searchInput) searchInput.value = "";
        document.getElementById("msgSearchResults").classList.add("hidden");
        document.getElementById("monitorLayout").classList.remove("hidden");

        // 2. Switch to Chat Monitor tab (but DON'T let it auto-call loadConversations â€”
        //    we'll do it ourselves so we can await it properly)
        document
          .querySelectorAll(".admin-tab")
          .forEach((b) => b.classList.remove("active"));
        const chatsBtn = document.querySelector('[data-tab="chats"]');
        if (chatsBtn) chatsBtn.classList.add("active");
        currentTab = "chats";
        document.getElementById("userTableWrap").classList.add("hidden");
        document.getElementById("adminToolbar").classList.add("hidden");
        document.getElementById("storagePanel").classList.add("hidden");
        document.getElementById("chatsPanel").classList.remove("hidden");
        document.getElementById("flaggedPanel").classList.add("hidden");

        // 3. Load conversations if not yet loaded, then open target conversation
        if (!allConversations.length) {
          await loadConversations();
        }
        await openMonitorConv(cid);

        // 4. Scroll the conversation item into view in the left panel
        setTimeout(() => {
          const el = document.querySelector(
            `.monitor-conv-item[data-cid="${cid}"]`,
          );
          if (el) el.scrollIntoView({ behavior: "smooth", block: "nearest" });
        }, 100);
      }

      // â”€â”€ Refresh chats (conv list + current open conversation) â”€â”€
      async function refreshChats() {
        await loadConversations();
        if (currentMonitorCid) {
          await openMonitorConv(currentMonitorCid);
        }
      }

      // â”€â”€ Message Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function debounceMessageSearch(q) {
        clearTimeout(msgSearchDebounce);
        if (q.trim().length < 2) {
          document.getElementById("msgSearchResults").classList.add("hidden");
          document.getElementById("monitorLayout").classList.remove("hidden");
          return;
        }
        msgSearchDebounce = setTimeout(() => runMessageSearch(q.trim()), 400);
      }

      async function runMessageSearch(q) {
        document.getElementById("monitorLayout").classList.add("hidden");
        document.getElementById("msgSearchResults").classList.remove("hidden");
        document.getElementById("msgSearchList").innerHTML =
          `<div class="table-empty" style="padding:24px;">Searchingâ€¦</div>`;

        try {
          const res = await fetch(
            `${API_BASE}/admin/messages/search?q=${encodeURIComponent(q)}`,
            { headers: { Authorization: "Bearer " + adminToken } },
          );
          const data = await res.json();
          if (!res.ok) {
            showToast(data.error || "Failed.");
            return;
          }

          const msgs = data.messages || [];
          document.getElementById("searchResultCount").textContent =
            `${msgs.length} result${msgs.length !== 1 ? "s" : ""} for "${q}"`;

          if (!msgs.length) {
            document.getElementById("msgSearchList").innerHTML =
              `<div class="table-empty" style="padding:24px;">No messages found.</div>`;
            return;
          }

          document.getElementById("msgSearchList").innerHTML = msgs
            .map((m) => {
              const convLabel =
                m.conv_type === "group" ? m.conv_name || "Group" : "Direct";
              return `<div class="search-msg-row ${m.is_flagged ? "flagged" : ""}" data-mid="${m.id}">
              <div class="search-msg-meta">
                <span class="monitor-sender-name">${escapeHtml(m.full_name || m.username)}</span>
                <span class="monitor-sender-handle">@${escapeHtml(m.username)}</span>
                <span class="conv-type-badge ${m.conv_type === "group" ? "group" : ""}">${escapeHtml(convLabel)}</span>
                <span class="monitor-msg-time">${formatDateTime(m.created_at)}</span>
                ${m.is_flagged ? '<span class="flag-indicator">ğŸš©</span>' : ""}
              </div>
              <div class="search-msg-body">${escapeHtml(m.body || "[attachment]").replace(new RegExp("(" + escapeRegex(q) + ")", "gi"), "<mark>$1</mark>")}</div>
              <div class="monitor-msg-actions">
                <button class="monitor-btn view" onclick="viewConvFromFlag(${m.conversation_id})">View Chat</button>
                ${
                  m.is_flagged
                    ? `<button class="monitor-btn unflag" onclick="unflagMessage(${m.id},this)">Remove Flag</button>`
                    : `<button class="monitor-btn flag" onclick="showFlagDialog(${m.id},this)">ğŸš© Flag</button>`
                }
              </div>
            </div>`;
            })
            .join("");
        } catch (err) {
          showToast("Connection error.");
          console.error(err);
        }
      }

      // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function formatDateTime(dt) {
        if (!dt) return "â€”";
        const d = new Date(dt.replace(" ", "T"));
        return (
          d.toLocaleDateString([], { month: "short", day: "numeric" }) +
          " " +
          d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
        );
      }
      function escapeRegex(str) {
        return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      }
    </script>
  </body>
</html>
