<!--
  CampusChat Admin Control Panel
  
  Purpose: Administrative interface for system management and moderation
  Type: HTML5 Single Page Application (Admin Only)
  
  Features:
  - User account approval/rejection (pending queue)
  - Role assignment (Student, Faculty, Admin, Super Admin)
  - User account management (disable/enable)
  - System statistics and monitoring
  - Message moderation and flagging
  - Storage usage and cleanup
  - Conversation monitoring (super-admin)
  - Dashboard with key metrics
  
  Access Control:
  - Admin role minimum required
  - Super Admin for advanced moderation features
  - Redirects non-admin users to login
  
  Architecture:
  - Session verification before loading
  - Tabbed interface for different admin functions
  - Real-time data refresh
  - Responsive design for desktop/tablet
  
  Stylesheets: chat.css (shared), admin.css (admin-specific)
  Scripts: app.js (authentication), admin-specific code
-->

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CampusChat ‚Äî Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/admin-layout.css" />
    <link rel="stylesheet" href="css/admin-storage.css" />
    <link rel="stylesheet" href="css/admin-monitor.css" />
  </head>
  <body>
    <!-- Loading screen shown while checking saved session -->
    <div
      id="adminLoadingScreen"
      style="
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background: var(--bg-base);
        flex-direction: column;
        gap: 16px;
      "
    >
      <div
        style="
          width: 36px;
          height: 36px;
          border: 3px solid var(--border-strong);
          border-top-color: var(--accent);
          border-radius: 50%;
          animation: spin 0.7s linear infinite;
        "
      ></div>
      <div
        style="
          font-size: 13px;
          color: var(--text-muted);
          font-family: var(--font-mono);
        "
      >
        Checking session‚Ä¶
      </div>
    </div>

    <!-- Admin Login -->
    <div id="adminLogin" class="hidden">
      <div class="login-card">
        <div class="login-logo">
          <div class="login-logo-icon">üõ°Ô∏è</div>
          <div>
            <div class="login-logo-text">Campus<span>Chat</span></div>
            <div class="login-subtitle">ADMIN PANEL</div>
          </div>
        </div>
        <div class="field-group">
          <label>Username</label>
          <input
            id="adminUsername"
            type="text"
            placeholder="Admin username"
            autocomplete="username"
          />
        </div>
        <div class="field-group">
          <label>Password</label>
          <input id="adminPassword" type="password" placeholder="Password" />
        </div>
        <button class="btn-primary" onclick="adminLogin()">
          Sign In as Admin
        </button>
        <p id="adminLoginError"></p>
        <p
          style="
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 14px;
          "
        >
          <a href="/" style="color: var(--accent)">‚Üê Back to Chat</a>
        </p>
      </div>
    </div>

    <!-- Admin App -->
    <div id="adminApp" class="hidden">
      <div id="adminNav">
        <div class="admin-nav-logo">
          <span id="adminRoleIcon">üõ°Ô∏è</span>
          <span>CampusChat Admin</span>
          <span id="adminRoleBadge" class="admin-role-badge"></span>
        </div>
        <div class="admin-nav-tabs">
          <button
            class="admin-tab active"
            data-tab="pending"
            onclick="switchAdminTab(this, 'pending')"
          >
            Pending Approvals
            <span id="pendingCount" class="admin-badge hidden">0</span>
          </button>
          <button
            class="admin-tab"
            data-tab="active"
            onclick="switchAdminTab(this, 'active')"
          >
            Active Users
          </button>
          <button
            class="admin-tab"
            data-tab="disabled"
            onclick="switchAdminTab(this, 'disabled')"
          >
            Disabled
          </button>
          <!-- Storage tab: super_admin only ‚Äî shown via JS after login -->
          <button
            class="admin-tab hidden"
            id="chatsTabBtn"
            data-tab="chats"
            onclick="switchAdminTab(this, 'chats')"
          >
            üí¨ Chat Monitor
            <span id="flaggedCount" class="admin-badge hidden">0</span>
          </button>
          <button
            class="admin-tab hidden"
            id="flaggedTabBtn"
            data-tab="flagged"
            onclick="switchAdminTab(this, 'flagged')"
          >
            üö© Flagged
          </button>
          <button
            class="admin-tab hidden"
            id="storageTabBtn"
            data-tab="storage"
            onclick="switchAdminTab(this, 'storage')"
          >
            üíæ Storage
          </button>
        </div>
        <div class="admin-nav-right">
          <span
            id="adminMyName"
            style="font-size: 13px; color: var(--text-secondary)"
          ></span>
          <button
            id="adminThemeBtn"
            class="icon-btn"
            title="Toggle theme"
            onclick="toggleTheme()"
          >
            <svg
              id="adminThemeIcon"
              width="15"
              height="15"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="12" cy="12" r="5" />
              <line x1="12" y1="1" x2="12" y2="3" />
              <line x1="12" y1="21" x2="12" y2="23" />
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
              <line x1="1" y1="12" x2="3" y2="12" />
              <line x1="21" y1="12" x2="23" y2="12" />
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
            </svg>
          </button>
          <button class="icon-btn" title="Logout" onclick="adminLogout()">
            <svg
              width="15"
              height="15"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
              <polyline points="16 17 21 12 16 7" />
              <line x1="21" y1="12" x2="9" y2="12" />
            </svg>
          </button>
        </div>
      </div>

      <div id="adminContent">
        <!-- Search + filter bar (hidden on storage tab) -->
        <div class="admin-toolbar" id="adminToolbar">
          <div class="admin-search-wrap">
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="11" cy="11" r="8" />
              <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
            <input
              id="adminSearch"
              type="text"
              placeholder="Search users‚Ä¶"
              oninput="filterUsers(this.value)"
            />
          </div>
          <button
            class="btn-modal-primary"
            onclick="loadUsers()"
            style="padding: 8px 16px; font-size: 13px"
          >
            <svg
              width="13"
              height="13"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.2"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="display: inline; margin-right: 4px; vertical-align: middle"
            >
              <path d="M23 4v6h-6" />
              <path d="M1 20v-6h6" />
              <path
                d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
              />
            </svg>
            Refresh
          </button>
        </div>

        <!-- User table (shown on user tabs) -->
        <div id="userTableWrap">
          <table id="userTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Username</th>
                <th>Role</th>
                <th>Department</th>
                <th>Registered</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="userTableBody">
              <tr>
                <td colspan="6" class="table-empty">Loading‚Ä¶</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Chat Monitor panel (super_admin only) -->
        <div id="chatsPanel" class="hidden">
          <!-- Global message search -->
          <div class="monitor-search-bar">
            <div class="admin-search-wrap" style="max-width: 480px">
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
              </svg>
              <input
                id="msgSearchInput"
                type="text"
                placeholder="Search messages across all chats‚Ä¶"
                oninput="debounceMessageSearch(this.value)"
              />
            </div>
            <div class="conv-type-filter">
              <button
                class="filter-btn active"
                onclick="setConvFilter(this, 'all')"
              >
                All
              </button>
              <button
                class="filter-btn"
                onclick="setConvFilter(this, 'direct')"
              >
                Direct
              </button>
              <button class="filter-btn" onclick="setConvFilter(this, 'group')">
                Groups
              </button>
            </div>
            <button
              class="btn-modal-primary"
              onclick="refreshChats()"
              style="padding: 8px 16px; font-size: 13px"
            >
              Refresh
            </button>
          </div>

          <!-- Search results (hidden by default) -->
          <div id="msgSearchResults" class="hidden">
            <div class="section-label">
              Search Results
              <span id="searchResultCount" class="muted-count"></span>
            </div>
            <div id="msgSearchList"></div>
          </div>

          <!-- Conversation list + message viewer -->
          <div id="monitorLayout" class="monitor-layout">
            <!-- Left: conversation list -->
            <div id="monitorConvList" class="monitor-conv-list">
              <div class="table-empty" style="padding: 32px 16px">
                Click Refresh to load conversations.
              </div>
            </div>

            <!-- Right: message viewer -->
            <div id="monitorMsgPane" class="monitor-msg-pane">
              <div class="monitor-empty">
                <div style="font-size: 32px; margin-bottom: 12px">üí¨</div>
                <div style="font-size: 14px; color: var(--text-muted)">
                  Select a conversation to view messages
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Flagged Messages panel (super_admin only) -->
        <div id="flaggedPanel" class="hidden">
          <div class="storage-toolbar">
            <span style="font-size: 13px; color: var(--text-secondary)"
              >All flagged messages ‚Äî click üö© to unflag</span
            >
            <button
              class="btn-modal-primary"
              onclick="loadFlaggedMessages()"
              style="padding: 8px 16px; font-size: 13px"
            >
              Refresh
            </button>
          </div>
          <div id="flaggedList">
            <div class="table-empty" style="padding: 48px">
              Click Refresh to load flagged messages.
            </div>
          </div>
        </div>

        <!-- Storage panel (super_admin only) -->
        <div id="storagePanel" class="hidden">
          <div class="storage-stats">
            <div class="stat-card">
              <div class="stat-label">Total Files</div>
              <div class="stat-value" id="statTotalFiles">‚Äî</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">DB Tracked Size</div>
              <div class="stat-value" id="statDbSize">‚Äî</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Actual Disk Used</div>
              <div class="stat-value" id="statDiskUsed">‚Äî</div>
            </div>
            <div class="stat-card warn">
              <div class="stat-label">Stale Files (6+ months)</div>
              <div class="stat-value" id="statStaleCount">‚Äî</div>
            </div>
            <div class="stat-card warn">
              <div class="stat-label">Reclaimable Space</div>
              <div class="stat-value" id="statStaleSize">‚Äî</div>
            </div>
          </div>

          <div class="storage-toolbar">
            <span style="font-size: 13px; color: var(--text-secondary)"
              >Files not accessed in the last 6 months</span
            >
            <div style="display: flex; gap: 8px">
              <button
                class="btn-modal-primary"
                onclick="loadStorage()"
                style="padding: 8px 16px; font-size: 13px"
              >
                Refresh
              </button>
              <button
                class="action-btn reject"
                id="deleteAllBtn"
                onclick="cleanupAll()"
                style="padding: 8px 16px; font-size: 13px"
              >
                Delete All Stale
              </button>
            </div>
          </div>

          <div id="staleTableWrap">
            <table id="staleTable">
              <thead>
                <tr>
                  <th>
                    <input
                      type="checkbox"
                      id="selectAllStale"
                      onchange="toggleSelectAll(this)"
                    />
                  </th>
                  <th>File Name</th>
                  <th>Type</th>
                  <th>Size</th>
                  <th>Uploaded By</th>
                  <th>Last Accessed</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="staleTableBody">
                <tr>
                  <td colspan="7" class="table-empty">
                    Click Refresh to load storage data.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="storage-selection-bar hidden" id="selectionBar">
            <span id="selectionCount">0 files selected</span>
            <button class="action-btn reject" onclick="cleanupSelected()">
              Delete Selected
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="toast"></div>

        <script src="js/admin-auth.js"></script>
    <script src="js/admin-users.js"></script>
    <script src="js/admin-storage.js"></script>
    <script src="js/admin-monitor.js"></script>
  </body>
</html>